---
title: "Core Imageãƒ•ã‚£ãƒ«ã‚¿ã‚’æ´»ç”¨ã—ãŸUIImageã®ç”»åƒä¸€è‡´åˆ¤å®šãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Swift", "iOS", "CoreImage", "ç”»åƒå‡¦ç†", "UIImage"]
published: true
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯ã€Swiftã§æ›¸ã‹ã‚ŒãŸ `UIImage` ã®æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ `matchesImage(_:tolerance:)` ã«ã¤ã„ã¦ã€ç”»åƒã®ä¸€è‡´åˆ¤å®šã‚’è¡Œã†æ–¹æ³•ã¨ãã®åŸç†ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€iOSã‚¢ãƒ—ãƒªã§ç”»åƒæ¯”è¼ƒã®ãƒ‹ãƒ¼ã‚ºãŒã‚ã‚‹å ´åˆã«å½¹ç«‹ã¤ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€2ã¤ã®ç”»åƒãŒã©ã‚Œã ã‘ä¼¼ã¦ã„ã‚‹ã‹ã‚’ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã§åˆ¤å®šã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

# èƒŒæ™¯

æœ€åˆã«ã€ã“ã®ç”»åƒä¸€è‡´åˆ¤å®šã‚’å®Ÿè£…ã™ã‚‹éš›ã«ã¯ã€Core Graphics ã‚’ä½¿ã£ã¦1ãƒ”ã‚¯ã‚»ãƒ«ãšã¤æ¯”è¼ƒã™ã‚‹æ–¹æ³•ã‚’è©¦ã¿ã¾ã—ãŸã€‚ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã§ã¯éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã‚Šã€ç‰¹ã«ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã«ã¯å®Ÿç”¨çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãã“ã§ã€Core Image ã®ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ´»ç”¨ã—ãŸç¾åœ¨ã®å®Ÿè£…ã«å¤‰æ›´ã—ãŸçµæœã€å‡¦ç†æ™‚é–“ã¯ç´„1/10ã«çŸ­ç¸®ã•ã‚Œã¾ã—ãŸã€‚ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã§å®Ÿç”¨çš„ãªç”»åƒæ¯”è¼ƒãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚

# ã‚³ãƒ¼ãƒ‰å…¨æ–‡

```swift
import CoreImage
import UIKit

extension UIImage {
    /// ç”»åƒã®ä¸€è‡´åˆ¤å®š
    /// - Parameters:
    ///   - image: æ¯”è¼ƒå¯¾è±¡ã®UIImage
    ///   - tolerance: è¨±å®¹ã™ã‚‹ãƒ”ã‚¯ã‚»ãƒ«ã®èª¤å·®ï¼ˆ0.0ã‹ã‚‰1.0ã¾ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯0.1ï¼‰
    /// - Returns: ç”»åƒãŒè¨±å®¹ç¯„å›²å†…ã§ä¸€è‡´ã™ã‚‹å ´åˆã¯`true`ã€ãã‚Œä»¥å¤–ã¯`false`
    func matchesImage(_ image: UIImage, tolerance: CGFloat = 0.1) -> Bool {
        guard size == image.size else { return false }

        let ciImage1 = CIImage(image: self)!
        let ciImage2 = CIImage(image: image)!

        // CIDifferenceBlendModeãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ç”¨ã—ã¦å·®åˆ†ã‚’è¨ˆç®—
        let differenceFilter = CIFilter(name: "CIDifferenceBlendMode")!
        differenceFilter.setValue(ciImage1, forKey: kCIInputImageKey)
        differenceFilter.setValue(ciImage2, forKey: kCIInputBackgroundImageKey)
      
        // ãƒ•ã‚£ãƒ«ã‚¿ã‚’é©ç”¨ã—ãŸçµæœã‚’å–å¾—
        let outputImage = differenceFilter.outputImage!

        // å¹³å‡è‰²ã‚’è¨ˆç®—ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ç”¨
        let extentVector = CIVector(x: outputImage.extent.origin.x, y: outputImage.extent.origin.y, z: outputImage.extent.size.width, w: outputImage.extent.size.height)
        let avgFilter = CIFilter(name: "CIAreaAverage", parameters: [kCIInputImageKey: outputImage, kCIInputExtentKey: extentVector])!
        let avgOutputImage = avgFilter.outputImage! // avgOutputImage ã¯ 1 ãƒ”ã‚¯ã‚»ãƒ«ã«åœ§ç¸®ã•ã‚ŒãŸå¹³å‡è‰²ã®ç”»åƒã§ã™

        // CIContextã‚’ä½¿ã£ã¦ã€å¹³å‡è‰²ã‚’å–å¾—
        let context = CIContext(options: nil)
        var bitmap = [UInt8](repeating: 0, count: 4)
        context.render(avgOutputImage, toBitmap: &bitmap, rowBytes: 4, bounds: CGRect(x: 0, y: 0, width: 1, height: 1), format: .RGBA8, colorSpace: nil)

        // å¹³å‡è‰²ãŒã‚¼ãƒ­ï¼ˆå·®åˆ†ãªã—ï¼‰ã«è¿‘ã‘ã‚Œã°ç”»åƒã¯ä¸€è‡´ã—ã¦ã„ã‚‹
        let diffR = CGFloat(bitmap[0]) / 255.0
        let diffG = CGFloat(bitmap[1]) / 255.0
        let diffB = CGFloat(bitmap[2]) / 255.0

        // RGBã®å¹³å‡å€¤ãŒè¨±å®¹èª¤å·®ä»¥ä¸‹ã§ã‚ã‚Œã°ã€ä¸€è‡´ã¨ã¿ãªã™
        let totalDifference = (diffR + diffG + diffB) / 3.0
        return totalDifference <= tolerance
    }
}
```

# ç”»åƒä¸€è‡´åˆ¤å®šãƒ¡ã‚½ãƒƒãƒ‰ã®æ¦‚è¦

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€`UIImage` ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªç”»åƒæ¯”è¼ƒæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

- **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: æ¯”è¼ƒå¯¾è±¡ã¨ãªã‚‹ã‚‚ã†ä¸€ã¤ã® `UIImage` ã¨ã€è¨±å®¹ã™ã‚‹èª¤å·® (`tolerance`) ã‚’è¨­å®šã§ãã¾ã™ã€‚
- **è¿”ã‚Šå€¤**: ç”»åƒãŒæŒ‡å®šã—ãŸèª¤å·®ã®ç¯„å›²ã§ä¸€è‡´ã™ã‚‹å ´åˆã¯ `true`ã€ä¸€è‡´ã—ãªã„å ´åˆã¯ `false` ã‚’è¿”ã—ã¾ã™ã€‚

`tolerance` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ã†ã“ã¨ã§ã€å®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ãªãã¦ã‚‚ã‚ãšã‹ãªé•ã„ã‚’è¨±å®¹ã™ã‚‹æŸ”è»Ÿãªä¸€è‡´åˆ¤å®šãŒå¯èƒ½ã§ã™ã€‚

# å®Ÿè£…ã®è©³ç´°

ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é€²è¡Œã—ã¾ã™:

## 1. ã‚µã‚¤ã‚ºã®ä¸€è‡´ç¢ºèª

```swift
guard size == image.size else { return false }
```

ã¾ãšã€ç”»åƒã®ã‚µã‚¤ã‚ºãŒç•°ãªã‚‹å ´åˆã€å³åº§ã« `false` ã‚’è¿”ã—ã¾ã™ã€‚ã‚µã‚¤ã‚ºãŒé•ã†ç”»åƒã¯ç•°ãªã‚‹ã¨ã¿ãªã•ã‚Œã€ã“ã‚Œä»¥é™ã®æ¯”è¼ƒå‡¦ç†ã¯ç„¡é§„ã«ãªã‚‹ãŸã‚ã§ã™ã€‚

## 2. CIImageã®ç”Ÿæˆ

```swift
let ciImage1 = CIImage(image: self)!
let ciImage2 = CIImage(image: image)!
```

`UIImage` ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰ `CIImage` ã‚’ç”Ÿæˆã—ã¾ã™ã€‚`CIImage` ã¯ Core Image ã§ç”»åƒå‡¦ç†ã‚’è¡Œã†ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

## 3. CIDifferenceBlendModeãƒ•ã‚£ãƒ«ã‚¿ã«ã‚ˆã‚‹å·®åˆ†è¨ˆç®—

```swift
let differenceFilter = CIFilter(name: "CIDifferenceBlendMode")!
differenceFilter.setValue(ciImage1, forKey: kCIInputImageKey)
differenceFilter.setValue(ciImage2, forKey: kCIInputBackgroundImageKey)
```

`CIDifferenceBlendMode` ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€2ã¤ã®ç”»åƒã®å·®åˆ†ã‚’è¨ˆç®—ã—ã¾ã™ã€‚ã“ã®ãƒ•ã‚£ãƒ«ã‚¿ã¯å„ãƒ”ã‚¯ã‚»ãƒ«ã§å·®åˆ†ã‚’ã¨ã‚Šã€ã©ã‚Œã ã‘ç•°ãªã‚‹ã‹ã‚’æ˜ã‚‰ã‹ã«ã—ã¾ã™ã€‚

## 4. å¹³å‡è‰²ã®è¨ˆç®—

```swift
let outputImage = differenceFilter.outputImage!
// ç”»åƒå…¨ä½“ã‚’è¡¨ã™ç¯„å›²ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
let extentVector = CIVector(x: outputImage.extent.origin.x, y: outputImage.extent.origin.y, z: outputImage.extent.size.width, w: outputImage.extent.size.height)
let avgFilter = CIFilter(name: "CIAreaAverage", parameters: [kCIInputImageKey: outputImage, kCIInputExtentKey: extentVector])!
let avgOutputImage = avgFilter.outputImage! // avgOutputImage ã¯ 1 ãƒ”ã‚¯ã‚»ãƒ«ã«åœ§ç¸®ã•ã‚ŒãŸå¹³å‡è‰²ã®ç”»åƒã§ã™
```

å·®åˆ†ç”»åƒã‹ã‚‰ã€`CIAreaAverage` ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã£ã¦å…¨ä½“ã®å¹³å‡è‰²ã‚’è¨ˆç®—ã—ã¾ã™ã€‚å·®åˆ†ãŒãªã„å ´åˆã€å¹³å‡è‰²ã¯ã»ã¼ã‚¼ãƒ­ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç”»åƒãŒã©ã‚Œã»ã©ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’å®šé‡çš„ã«è©•ä¾¡ã—ã¾ã™ã€‚

## 5. å¹³å‡è‰²ã®å–å¾—ã¨ä¸€è‡´åˆ¤å®š

```swift
let context = CIContext(options: nil)
var bitmap = [UInt8](repeating: 0, count: 4)
context.render(avgOutputImage, toBitmap: &bitmap, rowBytes: 4, bounds: CGRect(x: 0, y: 0, width: 1, height: 1), format: .RGBA8, colorSpace: nil)
```

ã“ã“ã§ã¯ã€`CIContext` ã‚’ä½¿ã£ã¦ `avgOutputImage` ã®å¹³å‡è‰²ã‚’å–å¾—ã—ã€ãã®çµæœã‚’ `bitmap` é…åˆ—ã«æ ¼ç´ã—ã¦ã„ã¾ã™ã€‚ã“ã“ã§å¾—ã‚‰ã‚Œã‚‹è‰²æˆåˆ† (R, G, B) ã‚’ã‚‚ã¨ã«å·®åˆ†ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

æ¬¡ã«ã€RGBæˆåˆ†ã‚’æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒã—ã¾ã™ã€‚

```swift
let diffR = CGFloat(bitmap[0]) / 255.0
let diffG = CGFloat(bitmap[1]) / 255.0
let diffB = CGFloat(bitmap[2]) / 255.0
let totalDifference = (diffR + diffG + diffB) / 3.0
return totalDifference <= tolerance
```

å¹³å‡è‰²ã® RGB æˆåˆ†ã‚’0ã‹ã‚‰1ã®ç¯„å›²ã«å¤‰æ›ã—ã€ãã‚Œã‚‰ã®å¹³å‡å€¤ãŒæŒ‡å®šã•ã‚ŒãŸè¨±å®¹èª¤å·® (`tolerance`) ä»¥ä¸‹ã§ã‚ã‚Œã°ç”»åƒã¯ä¸€è‡´ã—ã¦ã„ã‚‹ã¨ã¿ãªã—ã¾ã™ã€‚

# ã“ã®ã‚³ãƒ¼ãƒ‰ã®ç›®çš„ã¨è¨±å®¹äº‹é …

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ä¸»ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å‘ã‘ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡Œç‚¹ãŒæŒ‡æ‘˜ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆç”¨é€”ã§ã®åˆ©ä¾¿æ€§ã‚’é‡è¦–ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã®ç‚¹ã«ã¤ã„ã¦ã¯è¨±å®¹ã—ã¦ã„ã¾ã™ã€‚

- **å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ—ã«ã‚ˆã‚‹ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ãƒªã‚¹ã‚¯**: å¼·åˆ¶ã‚¢ãƒ³ãƒ©ãƒƒãƒ— (`!`) ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ç¢ºå®Ÿã«æœ‰åŠ¹ãªå…¥åŠ›ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å¢—åŠ **: Core Image ã®åˆ©ç”¨ã«ä¼´ã†ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒå¢—åŠ ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆç”¨é€”ã§ã¯è¨±å®¹ç¯„å›²ã¨ã—ã¦ã„ã¾ã™ã€‚
- **å‡¦ç†ã®é‡ã•**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®ä½¿ç”¨ã¯æƒ³å®šã—ã¦ã„ãªã„ãŸã‚ã€å‡¦ç†ã®é‡ã•ã«ã¤ã„ã¦ã¯å•é¡Œè¦–ã—ã¦ã„ã¾ã›ã‚“ã€‚
- **ã‚«ãƒ©ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹ã®æ‰±ã„**: ã‚«ãƒ©ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹ã®é•ã„ã«ã‚ˆã‚‹å½±éŸ¿ãŒã‚ã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€ãƒ†ã‚¹ãƒˆã®ç›®çš„ä¸Šã€ãã‚Œã»ã©å³å¯†ãªä¸€è‡´ã‚’æ±‚ã‚ã¦ã„ãªã„ãŸã‚ã€è¨±å®¹ã—ã¦ã„ã¾ã™ã€‚

# åˆ©ç”¨ä¾‹ã¨æ³¨æ„ç‚¹

## åˆ©ç”¨ä¾‹

ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚

- **ç”»åƒã®ãƒ†ã‚¹ãƒˆ**: UIãƒ†ã‚¹ãƒˆã‚„ã€å‡¦ç†ã®çµæœã¨ã—ã¦æœŸå¾…ã™ã‚‹ç”»åƒã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ãŸã„å ´åˆã€‚
- **é‡è¤‡ç”»åƒã®æ¤œå‡º**: ç”»åƒãƒ©ã‚¤ãƒ–ãƒ©ãƒªå†…ã§é‡è¤‡ã—ã¦ã„ã‚‹ç”»åƒã‚’æ¤œå‡ºã—ãŸã„å ´åˆã€‚

## æ³¨æ„ç‚¹

- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ç”»åƒã®ã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€ã‚¢ãƒ—ãƒªã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã«ã¯å‘ã„ã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
- **æ­£ç¢ºæ€§**: è¨±å®¹èª¤å·® (`tolerance`) ã«ã‚ˆã£ã¦çµæœãŒå¤§ããå¤‰ã‚ã‚Šã¾ã™ã€‚å¾®å¦™ãªå·®ç•°ã‚’æ¤œå‡ºã—ãŸã„å ´åˆã€`tolerance` ã®å€¤ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

# ã¾ã¨ã‚

ã“ã®æ‹¡å¼µãƒ¡ã‚½ãƒƒãƒ‰ `matchesImage(_:tolerance:)` ã¯ã€Core Image ãƒ•ã‚£ãƒ«ã‚¿ã‚’æ´»ç”¨ã—ã¦2ã¤ã®ç”»åƒã®ä¸€è‡´åº¦ã‚’é«˜é€Ÿã«è©•ä¾¡ã—ã¾ã™ã€‚`CIDifferenceBlendMode` ãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã£ã¦å·®åˆ†ã‚’è¨ˆç®—ã—ã€`CIAreaAverage` ãƒ•ã‚£ãƒ«ã‚¿ã§å…¨ä½“ã®é•ã„ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã§ã€ã©ã®ç¨‹åº¦ç”»åƒãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚Šã€ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã®å³å¯†ãªä¸€è‡´åˆ¤å®šã‚’è¡Œã†ã ã‘ã§ãªãã€è¨±å®¹ç¯„å›²ã‚’æŒ‡å®šã—ã¦æŸ”è»Ÿãªä¸€è‡´åˆ¤å®šã‚‚å¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

ç”»åƒæ¯”è¼ƒã‚’åŠ¹ç‡çš„ã«å®Ÿè£…ã—ãŸã„å ´åˆã‚„ã€ã‚¢ãƒ—ãƒªå†…ã§ç”»åƒã®æ­£ç¢ºæ€§ã‚’æ‹…ä¿ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚·ãƒ¼ãƒ³ã§æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
