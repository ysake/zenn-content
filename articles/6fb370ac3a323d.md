---
title: "visionOS CompositorLayerÃ—Metalå…¥é–€ï¼šDrawable/Texture/Shaderæ•´ç†"
emoji: "ğŸ§©"
type: "tech"
topics: ["visionOS", "Metal", "SwiftUI", "CompositorServices"]
published: true
---

CompositorLayerã§Metalæç”»ã‚’å§‹ã‚ã‚‹ã¨ã€æœ€åˆã«æ¬¡ã®ç‚¹ã§æ··ä¹±ã—ãŒã¡ã§ã™ã€‚

- **Drawable** ã¯ä½•ã‚’è¡¨ã—ã¦ã„ã‚‹ã®ã‹
- **Texture** ã¯ã€Œç”»åƒã€ã¨ä½•ãŒé•ã†ã®ã‹
- **Vertex/Fragmentã‚·ã‚§ãƒ¼ãƒ€ãƒ¼** ã¯ãã‚Œãã‚Œä½•ã‚’æ‹…å½“ã—ã¦ã„ã‚‹ã®ã‹

æœ¬è¨˜äº‹ã¯ã€CompositorLayer + Metalã®ã€Œæœ€å°æ§‹æˆã€ã‚’é¡Œæã«ã€ã“ã‚Œã‚‰ã®æ¦‚å¿µã‚’ä¸€åº¦æ•´ç†ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«ã—ã¦ã„ã¾ã™ã€‚  
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€æ·±åº¦ã€ã‚¹ãƒ†ãƒ¬ã‚ªï¼ˆå·¦å³ã®ç›®ï¼‰ã¨ã„ã£ãŸè©±é¡Œã¯é‡è¦ã§ã™ãŒã€ä»Šå›ã¯**è§¦ã‚Šï¼ˆå…¥å£ï¼‰**ã«ç•™ã‚ã¾ã™ã€‚

â€»APIåã¯visionOS SDKã®å·®åˆ†ã§å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€å€‹ã€…ã®åå‰ã‚ˆã‚Šã‚‚ã€Œå‡¦ç†ã®æµã‚Œã€ã¨ã€Œè²¬å‹™ã®å¯¾å¿œé–¢ä¿‚ã€ã‚’é‡è¦–ã—ã¾ã™ã€‚

## å…ˆã«å…¨ä½“åƒ

CompositorLayer + Metalã®åŸºæœ¬çš„ãªæµã‚Œã¯ã€æ¦‚ã­æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

1. æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ æƒ…å ±ã‚’å–å¾—ã™ã‚‹
2. Drawableï¼ˆãã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§æç”»ãƒ»æå‡ºã—ã¦ã‚ˆã„æç”»å…ˆï¼‰ã‚’å–å¾—ã™ã‚‹
3. DrawableãŒæŒã¤textureï¼ˆè‰²/æ·±åº¦ï¼‰ã‚’RenderPassã«å‰²ã‚Šå½“ã¦ã‚‹
4. Vertex/Fragmentã§æç”»ã™ã‚‹
5. `present(drawable)` ã§è¡¨ç¤ºã«å›ã™

ã“ã®å¯¾å¿œé–¢ä¿‚ãŒæŠŠæ¡ã§ãã‚‹ã¨ã€å¾Œã‹ã‚‰è¡Œåˆ—ãƒ»æ·±åº¦ãƒ»ã‚¹ãƒ†ãƒ¬ã‚ªã¸é€²ã‚“ã éš›ã‚‚è¦‹é€šã—ãŒè‰¯ããªã‚Šã¾ã™ã€‚

## ç”¨èªæ•´ç†ï¼ˆæœ€ä½é™ï¼‰

### Drawable

- ã€Œã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§æç”»ã—ã¦ã‚ˆã„ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é›†åˆã§ã™
- å…¸å‹çš„ã«ã¯ **è‰²ãƒ†ã‚¯ã‚¹ãƒãƒ£** ã¨ **æ·±åº¦ãƒ†ã‚¯ã‚¹ãƒãƒ£** ã‚’å«ã¿ã¾ã™
- `present(drawable)` ã«ã‚ˆã£ã¦ã€æç”»çµæœãŒè¡¨ç¤ºã¸å›ã•ã‚Œã¾ã™

ç›´æ„Ÿçš„ã«ã¯ã€Drawableã¯ã€Œãã®ç¬é–“ã«åˆ©ç”¨ã§ãã‚‹æç”»å…ˆã‚’å€Ÿã‚Šã‚‹ä»•çµ„ã¿ã€ã§ã™ã€‚

### Texture

- GPUãŒèª­ã¿æ›¸ãã™ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸï¼ˆ2Dé…åˆ—ã«è¿‘ã„æ¦‚å¿µï¼‰ã§ã™
- ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãã®ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆç”»åƒã¯textureã¸ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ©ç”¨ã—ã¾ã™ï¼‰
- DrawableãŒæŒã¤textureã¯ã€å¤šãã®å ´åˆã€Œå‡ºåŠ›å…ˆï¼ˆãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼‰ã€ã§ã™

### Vertex / Fragment ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼

- **Vertex**ï¼šé ‚ç‚¹ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã€å›³å½¢ã®å½¢ï¼ˆä½ç½®ï¼‰ã‚’å®šç¾©ã—ã¾ã™  
  æœ€ä½é™ `[[position]]`ï¼ˆclip spaceåº§æ¨™ï¼‰ã‚’å‡ºåŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- **Fragment**ï¼šãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã€æœ€çµ‚çš„ãªè‰²ã‚’æ±ºå®šã—ã¾ã™ã€‚
- VertexãŒå‡ºåŠ›ã—ãŸå±æ€§ï¼ˆè‰²ãƒ»UVãªã©ï¼‰ã¯ã€é€”ä¸­ã§è£œé–“ã•ã‚Œã¦Fragmentã«æ¸¡ã•ã‚Œã¾ã™ã€‚

## ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—éª¨æ ¼ï¼ˆDrawable â†’ RenderPass â†’ presentï¼‰

ä»¥ä¸‹ã§ã¯ã€ŒDrawableãŒä½•ã§ã€ã©ã“ã«ä½¿ã‚ã‚Œã‚‹ã®ã‹ã€ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—ã®éª¨æ ¼ã‚’ç¤ºã—ã¾ã™ã€‚

```swift
import CompositorServices
import Metal

/// CompositorLayer + Metal ã®æœ€å°éª¨æ ¼ã€‚
/// - ç›®çš„ï¼šDrawable / Texture / present ã®é–¢ä¿‚ãŒè…¹è½ã¡ã™ã‚‹ã“ã¨
/// - æ³¨ï¼šAPIåã¯SDKå·®åˆ†ãŒã‚ã‚Šå¾—ã‚‹ã®ã§ã€æ¦‚å¿µãŒåˆ†ã‹ã‚‹ã‚ˆã†ã«ã‚³ãƒ¡ãƒ³ãƒˆåšã‚
final class MetalEngine {
    private let layerRenderer: LayerRenderer

    // Metalã®åŸºæœ¬ã‚»ãƒƒãƒˆ
    private let device: MTLDevice
    private let queue: MTLCommandQueue

    init(layerRenderer: LayerRenderer) {
        self.layerRenderer = layerRenderer
        self.device = MTLCreateSystemDefaultDevice()!
        self.queue = device.makeCommandQueue()!
    }

    /// ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹ï¼ˆåŸºæœ¬ã¯åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰æ¨å¥¨ï¼‰
    func startRenderLoop() {
        let t = Thread { [weak self] in
            self?.renderLoop()
        }
        t.name = "Render Thread"
        t.start()
    }

    private func renderLoop() {
        while true {
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç ´æ£„ã•ã‚ŒãŸã‚‰çµ‚äº†
            if layerRenderer.state == .invalidated { return }

            // ä¸€æ™‚åœæ­¢ä¸­ã¯å†é–‹å¾…ã¡
            if layerRenderer.state == .paused {
                layerRenderer.waitUntilRunning()
                continue
            }

            // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å›åã—ã‚„ã™ãã™ã‚‹
            autoreleasepool { renderOneFrame() }
        }
    }

    private func renderOneFrame() {
        // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—ï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°æƒ…å ± + drawableå–å¾—ã®å…¥å£ï¼‰
        guard let frame = layerRenderer.queryNextFrame() else { return }
        guard let timing = frame.predictTiming() else { return }

        // ===== Update phaseï¼ˆCPUå´ã®æ›´æ–°ï¼‰=====
        frame.startUpdate()

        // ã“ã“ã§ã‚„ã‚‹ã“ã¨ã®ä¾‹ï¼š
        // - å…¥åŠ›ã®å–ã‚Šè¾¼ã¿ï¼ˆå§¿å‹¢ãƒ»ã‚¸ã‚§ã‚¹ãƒãƒ£ç­‰ï¼‰
        // - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é€²è¡Œ
        // - uniformï¼ˆè¡Œåˆ—ãƒ»æ™‚é–“ãªã©ï¼‰ã®æ›´æ–°
        // updateUniforms()

        frame.endUpdate()

        // ã€Œæç”»ã«æœ€é©ãªå…¥åŠ›æ™‚åˆ»ã€ã¾ã§å¾…ã¤
        // â€»ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚„ã‚‹ã¨UIãŒæ­¢ã¾ã‚‹ã®ã§åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰æ¨å¥¨
        LayerRenderer.Clock().wait(until: timing.optimalInputTime)

        // ===== Submission phaseï¼ˆGPUã¸æç”»å‘½ä»¤ã‚’ç©ã‚€ï¼‰=====
        frame.startSubmission()
        defer { frame.endSubmission() }

        // drawable = ã€Œã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã«æã„ã¦presentã—ã¦è‰¯ã„æç”»å…ˆã‚»ãƒƒãƒˆã€
        guard let drawable = frame.queryDrawable() else { return }

        // drawableãŒæŒã¤ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆè‰²/æ·±åº¦ï¼‰
        // æ³¨æ„ï¼šå®Ÿéš›ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã‚„æ§‹é€ ã¯SDKã§å·®åˆ†ãŒå‡ºã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
        // ã“ã®è¨˜äº‹ã§ã¯ã€ŒdrawableãŒcolor/depth textureã‚’æŒã¡ã€ãã‚Œã‚’render passã«å·®ã™ã€ã¨ã„ã†æ¦‚å¿µã‚’é‡è¦–ã—ã¾ã™ã€‚
        let colorTex = drawable.colorTextures[0]
        let depthTex = drawable.depthTextures[0]

        // ã€Œã©ã“ã«ã€ã©ã†åˆæœŸåŒ–ã—ã¦ã€ã©ã†ä¿å­˜æ–¹é‡ã§æãã‹ã€ã‚’æŒ‡å®šã™ã‚‹
        let pass = MTLRenderPassDescriptor()

        // --- Color attachmentï¼ˆè‰²ã®å‡ºåŠ›å…ˆï¼‰---
        pass.colorAttachments[0].texture = colorTex
        pass.colorAttachments[0].loadAction = .clear
        pass.colorAttachments[0].storeAction = .store
        pass.colorAttachments[0].clearColor = MTLClearColorMake(0, 0, 0, 1)

        // --- Depth attachmentï¼ˆæ·±åº¦ãƒ†ã‚¹ãƒˆç”¨ã®åœŸå°ï¼‰---
        pass.depthAttachment.texture = depthTex
        pass.depthAttachment.loadAction = .clear
        pass.depthAttachment.storeAction = .dontCare
        pass.depthAttachment.clearDepth = 1.0

        // GPUã«é€ã‚‹ã€Œã‚³ãƒãƒ³ãƒ‰åˆ—ã€
        guard let cb = queue.makeCommandBuffer() else { return }

        // æç”»ã‚³ãƒãƒ³ãƒ‰ã‚’æ›¸ãè¾¼ã‚€å£
        guard let enc = cb.makeRenderCommandEncoder(descriptor: pass) else { return }

        // æœ¬æ¥ã¯ã“ã“ã§æç”»ã™ã‚‹ï¼š
        // - pipelineStateï¼ˆVertex/Fragmentï¼‰æŒ‡å®š
        // - ãƒãƒƒãƒ•ã‚¡ã‚„uniformã‚’ã‚»ãƒƒãƒˆ
        // - draw call
        //
        // enc.setRenderPipelineState(pipelineState)
        // enc.setVertexBuffer(vertexBuffer, offset: 0, index: 0)
        // enc.drawPrimitives(type: .triangle, vertexStart: 0, vertexCount: 3)

        enc.endEncoding()

        // present(drawable) = ã€Œã“ã®drawableã‚’è¡¨ç¤ºã«å›ã—ã¦ã­ã€
        cb.present(drawable)

        // å®Ÿè¡Œé–‹å§‹ï¼ˆGPUã¯éåŒæœŸã«å‹•ãï¼‰
        cb.commit()
    }
}
```

èª­ã¿ã©ã“ã‚ã¯æ¬¡ã®3ç‚¹ã§ã™ã€‚

- `queryDrawable()` ã§ã€Œãã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§æç”»ã—ã¦ã‚ˆã„æç”»å…ˆã€ã‚’å–å¾—ã™ã‚‹ã“ã¨
- `MTLRenderPassDescriptor` ã«ã€Drawableç”±æ¥ã® **è‰²/æ·±åº¦texture** ã‚’å‰²ã‚Šå½“ã¦ã¦ã„ã‚‹ã“ã¨
- `present(drawable)` ãŒã€Œè¡¨ç¤ºã¸å›ã™ã€åˆå›³ã«ãªã£ã¦ã„ã‚‹ã“ã¨

## ãƒãƒã‚Šã©ã“ã‚ï¼šdeviceAnchor ã‚’ã‚»ãƒƒãƒˆã—ãªã„ã¨ present ã•ã‚Œãªã„

CompositorServices ã® `LayerRenderer.Drawable` ã«ã¯ `deviceAnchor` ãŒã‚ã‚Šã¾ã™ã€‚  
ã“ã‚ŒãŒ `nil` ã®ã¾ã¾ `present(drawable)` ã‚’è¡Œã†ã¨ã€æ¬¡ã®ãƒ­ã‚°ãŒå‡ºã¦è¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Presenting a drawable without a device anchor. This drawable won't be presented.

å¯¾ç­–ã¯ã€**submission ãƒ•ã‚§ãƒ¼ã‚ºã§ â€œpresentation timeï¼ˆæç¤ºäºˆå®šæ™‚åˆ»ï¼‰â€ ã«å¯¾å¿œã™ã‚‹ DeviceAnchor ã‚’å–å¾—ã—ã€drawable ã«ã‚»ãƒƒãƒˆã—ã¦ã‹ã‚‰æç”»ãƒ»present ã™ã‚‹**ã“ã¨ã§ã™ã€‚

- DeviceAnchor ã¯ `WorldTrackingProvider.queryDeviceAnchor(atTimestamp:)` ã§å–å¾—ã—ã¾ã™
- å–å¾—ã«å¤±æ•—ã—ãŸï¼ˆnilï¼‰ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ã€ç„¡ç†ã« present ã›ãšã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ï¼ˆç‰¹ã«é–‹å§‹ç›´å¾Œï¼‰

```swift
/// `queryDrawable()` ã®ç›´å¾Œã€æç”»encodeã®å‰ã«å·®ã—è¾¼ã‚€æƒ³å®šã§ã™ã€‚
///
/// é‡è¦ï¼šdeviceAnchor ãŒ nil ã® drawable ã‚’ present ã™ã‚‹ã¨ã€
/// ã€ŒPresenting a drawable without a device anchor...ã€ã¨ãªã‚Šè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
///
/// å–å¾—å…ƒï¼šARKit ã® WorldTrackingProviderï¼ˆä¾‹ï¼š`worldTracking`ï¼‰
/// - `queryDeviceAnchor(atTimestamp:)` ã«æ¸¡ã™ timestamp ã¯ã€Œæç¤ºäºˆå®šæ™‚åˆ»ï¼ˆpresentation timeï¼‰ç›¸å½“ã€ã‚’ä½¿ã„ã¾ã™ã€‚
/// - èµ·å‹•ç›´å¾Œãªã©ã€anchor ãŒå–ã‚Œãªã„ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ã€‚
guard let drawable = frame.queryDrawable() else { return }

// â€» timing ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã¯SDKå·®åˆ†ãŒã‚ã‚Šå¾—ã¾ã™ã€‚
// ã€Œæç¤ºäºˆå®šæ™‚åˆ»ï¼ˆpresentation timeï¼‰ç›¸å½“ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
let presentationTimeSeconds = timing.presentationTime

guard let deviceAnchor = worldTracking.queryDeviceAnchor(atTimestamp: presentationTimeSeconds) else {
    // anchor ãŒå–ã‚Œãªã„ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ç„¡ç†ã« present ã—ãªã„æ–¹ãŒå®‰å®šã—ã¾ã™
    return
}

drawable.deviceAnchor = deviceAnchor
```

## Vertexã¨Fragmentã®é–¢ä¿‚ï¼ˆæœ€çŸ­ã®æ•´ç†ï¼‰

GPUãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç°¡ç•¥åŒ–ã™ã‚‹ã¨ã€æ¬¡ã®é †ã«é€²ã¿ã¾ã™ã€‚

- Vertexï¼ˆé ‚ç‚¹å˜ä½ï¼‰ï¼šä½ç½®ã¨å±æ€§ã‚’å‡ºåŠ›ã™ã‚‹
- ãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºï¼šä¸‰è§’å½¢ã‚’ãƒ”ã‚¯ã‚»ãƒ«ã®é›†åˆã¸å¤‰æ›ã—ã€å±æ€§ã‚’è£œé–“ã™ã‚‹
- Fragmentï¼ˆãƒ”ã‚¯ã‚»ãƒ«å˜ä½ï¼‰ï¼šè£œé–“ã•ã‚ŒãŸå±æ€§ã‚’å—ã‘å–ã‚Šã€æœ€çµ‚è‰²ã‚’å‡ºåŠ›ã™ã‚‹

ã“ã®ã€Œè£œé–“ã•ã‚Œã¦æ¸¡ã‚‹ã€ã¨ã„ã†ç‚¹ãŒã€Vertex/Fragmentã®é–¢ä¿‚ã‚’ç†è§£ã™ã‚‹éµã«ãªã‚Šã¾ã™ã€‚

## Metalã‚³ãƒ¼ãƒ‰ï¼šVertexâ†’Fragmentã¸è‰²ã‚’æ¸¡ã™æœ€å°ä¾‹

æ¬¡ã®ä¾‹ã¯ã€Vertexã§é ‚ç‚¹ã”ã¨ã«è‰²ã‚’å‡ºã—ã€ãã‚ŒãŒãƒ©ã‚¹ã‚¿ãƒ©ã‚¤ã‚ºã§è£œé–“ã•ã‚Œã¦Fragmentã«å…¥ã‚‹æ§˜å­ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æœ€å°ã‚µãƒ³ãƒ—ãƒ«ã§ã™ï¼ˆé ‚ç‚¹ãŒèµ¤/ç·‘/é’ â†’ é¢å†…ãŒæ»‘ã‚‰ã‹ã«æ··ã–ã‚Šã¾ã™ï¼‰ã€‚

```metal
#include <metal_stdlib>
using namespace metal;

/// Vertex â†’ Fragment ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ï¼ˆvaryingï¼‰ã€‚
/// - position ã¯å¿…é ˆï¼ˆclip spaceï¼‰
/// - color ã¯ä»»æ„ï¼ˆä»Šå›ã¯é–¢ä¿‚æ€§ã‚’è¦‹ã›ã‚‹ãŸã‚ã«æ¸¡ã™ï¼‰
struct VSOut {
    float4 position [[position]];
    float3 color;
};

/// vertex_id ã ã‘ã§ä¸‰è§’å½¢ã‚’ä½œã‚‹æœ€å°ã‚µãƒ³ãƒ—ãƒ«ã€‚
/// - é ‚ç‚¹ã”ã¨ã«è‰²ã‚’å‡ºã—ã¦ã€é€”ä¸­ã§è£œé–“ã•ã‚Œã‚‹ã“ã¨ã‚’è¦‹ã›ã‚‹
vertex VSOut vsMain(uint vid [[vertex_id]]) {
    // 3é ‚ç‚¹ã®ä½ç½®ï¼ˆz=0, w=1 ãªã®ã§å¹³é¢ï¼‰
    float2 pos[3] = {
        float2(-0.8, -0.8),
        float2( 0.0,  0.8),
        float2( 0.8, -0.8)
    };

    // é ‚ç‚¹ã”ã¨ã®è‰²ï¼ˆã‚ã¨ã§ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«è£œé–“ã•ã‚Œã‚‹ï¼‰
    float3 col[3] = {
        float3(1.0, 0.0, 0.0), // èµ¤
        float3(0.0, 1.0, 0.0), // ç·‘
        float3(0.0, 0.0, 1.0)  // é’
    };

    VSOut o;
    o.position = float4(pos[vid], 0.0, 1.0);
    o.color = col[vid];
    return o;
}

/// Fragment ã¯ãƒ”ã‚¯ã‚»ãƒ«ï¼ˆãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆï¼‰ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚
/// - stage_in ã«å…¥ã£ã¦ãã‚‹ color ã¯ã€Œè£œé–“æ¸ˆã¿ã€ãªã®ã§ã€ä¸‰è§’å½¢å†…éƒ¨ãŒã‚°ãƒ©ãƒ‡ã«ãªã‚‹
fragment float4 fsMain(VSOut in [[stage_in]]) {
    return float4(in.color, 1.0);
}
```

## ã“ã“ã¾ã§ã§æ•´ç†ã§ãã‚‹ã“ã¨

- VertexãŒ `[[position]]` ã‚’å‡ºåŠ›ã—ã¦å½¢ã‚’æ±ºã‚ã‚‹
- VertexãŒå‡ºåŠ›ã—ãŸå±æ€§ï¼ˆè‰²/UVãªã©ï¼‰ã¯ã€ãƒ”ã‚¯ã‚»ãƒ«å˜ä½ã«è£œé–“ã•ã‚Œã¦Fragmentã¸æ¸¡ã‚‹
- FragmentãŒå‡ºåŠ›ã—ãŸè‰²ãŒã€color attachmentï¼ˆtextureï¼‰ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹
- ãã®textureã‚’æŒã¤Drawableã‚’ `present(drawable)` ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹

## è§¦ã‚Šã ã‘ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ / æ·±åº¦ / ã‚¹ãƒ†ãƒ¬ã‚ªï¼ˆå…¥å£ï¼‰

æœ¬è¨˜äº‹ã§ã¯æ·±æ˜ã‚Šã—ã¾ã›ã‚“ãŒã€æ¬¡ã®ãƒ†ãƒ¼ãƒãŒè‡ªç„¶ãªæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ãªã‚Šã¾ã™ã€‚

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

- ä»Šå›ã¯æ‰‹æ›¸ãåº§æ¨™ã‚’ãã®ã¾ã¾ `[[position]]` ã«å…¥ã‚Œã‚‹æ§‹æˆã§ã™
- 3DåŒ–ã™ã‚‹å ´åˆã¯ `model * view * projection` è¡Œåˆ—ã§å¤‰æ›ã—ã€`[[position]]` ã‚’å‡ºåŠ›ã—ã¾ã™

### æ·±åº¦

- æ·±åº¦textureã‚’RenderPassã«å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ã€Œæ·±åº¦ãƒ†ã‚¹ãƒˆã®åœŸå°ã€ãŒã§ãã¾ã™
- å®Ÿéš›ã«æ·±åº¦ãƒ†ã‚¹ãƒˆã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ `MTLDepthStencilState` ã‚’ä½œæˆã—ã¦encoderã¸è¨­å®šã—ã¾ã™

### ã‚¹ãƒ†ãƒ¬ã‚ªï¼ˆå·¦å³ã®ç›®ï¼‰

- ç›®ã”ã¨ã« view / projection ãŒç•°ãªã‚Šã€æç”»ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚‚è¤‡æ•°ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ãŒä¸€èˆ¬çš„ã§ã™
- ã¾ãšã¯ã€ŒDrawableãŒå˜ä¸€ã®1æštextureã¨ã¯é™ã‚‰ãªã„ã€ã¨ã„ã†èªè­˜ãŒå…¥å£ã«ãªã‚Šã¾ã™

## ã¾ã¨ã‚

CompositorLayerã§Metalã‚’å§‹ã‚ã‚‹éš›ã®æœ€åˆã®ãƒã‚¤ãƒ³ãƒˆã¯ã€æ¬¡ã®å¯¾å¿œé–¢ä¿‚ã§ã™ã€‚

- Drawableï¼šãã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§åˆ©ç”¨ã§ãã‚‹æç”»å…ˆã‚»ãƒƒãƒˆ
- Textureï¼šGPUãŒèª­ã¿æ›¸ãã™ã‚‹ãƒ¡ãƒ¢ãƒªé ˜åŸŸï¼ˆç”»åƒãã®ã‚‚ã®ã§ã¯ãªã„ï¼‰
- Vertex/Fragmentï¼šå½¢ã‚’ä½œã‚‹ï¼è‰²ã‚’æ±ºã‚ã‚‹ï¼ˆå±æ€§ã¯è£œé–“ã•ã‚Œã¦æ¸¡ã‚‹ï¼‰

ã“ã“ãŒæ•´ç†ã§ãã‚‹ã¨ã€è¡Œåˆ—ãƒ»æ·±åº¦ãƒ»ã‚¹ãƒ†ãƒ¬ã‚ªã¨ã„ã£ãŸç™ºå±•çš„ãªè¦ç´ ã«ã‚‚ä¸€è²«ã—ãŸç†è§£ã§é€²ã‚ã¾ã™ã€‚